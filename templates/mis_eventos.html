<!doctype html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Mis eventos - Quercus</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
  <style>
    body.menu-page { text-align: center; }

    .mis-events-wrapper{
      max-width: 1300px;
      margin: 80px auto;
      padding: 20px;
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 28px;
    }

    /* LISTADO IZQUIERDO */
    .mis-events-list{
      max-height: 800px;
      overflow-y: auto;
      padding-right: 12px;
    }

    .mis-event-card{
      background: #f9f9fb;
      border-left: 4px solid #8c75e6;
      padding: 16px;
      border-radius: 10px;
      margin-bottom: 14px;
      text-align: left;
      box-shadow: 0 6px 18px rgba(0,0,0,0.06);
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .mis-event-card:hover{
      transform: translateY(-2px);
      box-shadow: 0 8px 22px rgba(0,0,0,0.1);
    }

    .mis-event-card h3{
      margin: 0 0 6px 0;
      font-size: 18px;
      color: #333;
    }

    .mis-event-card p{
      margin: 3px 0;
      font-size: 14px;
      color: #555;
    }

    .mis-event-fecha{
      color: #8c75e6;
      font-weight: 600;
    }

    .mis-event-actions{
      margin-top: 8px;
    }

    .btn-ver-qr{
      background: #8c75e6;
      color: #fff;
      border: 0;
      border-radius: 999px;
      padding: 6px 14px;
      font-weight: 700;
      font-size: 13px;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .btn-ver-qr:hover{
      transform: translateY(-1px);
      box-shadow: 0 4px 10px rgba(0,0,0,0.12);
      background: #7a63d3;
    }

    .btn-cancelar-evento{
      background: #e74c3c;
      color: #fff;
      border: 0;
      border-radius: 999px;
      padding: 6px 14px;
      font-weight: 700;
      font-size: 13px;
      cursor: pointer;
      transition: all 0.2s ease;
      margin-left: 8px;
    }

    .btn-cancelar-evento:hover{
      transform: translateY(-1px);
      box-shadow: 0 4px 10px rgba(0,0,0,0.12);
      background: #ff6b6b;
    }

    /* Mejorar bot√≥n cerrar del modal QR */
    #qr-modal #qr-close {
      background: #8c75e6;
      color: #fff;
      border: 0;
      border-radius: 999px;
      padding: 8px 20px;
      font-weight: 700;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    #qr-modal #qr-close:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 10px rgba(0,0,0,0.12);
      background: #7a63d4;
    }

    /* CALENDARIO DERECHO */
    #calendar-section{
      background:#f9f9fb;
      border-radius:14px;
      padding:20px;
      box-shadow:0 6px 18px rgba(0,0,0,0.06);
      height: fit-content;
      position: sticky;
      top: 100px;
    }

    #calendar-section h3{
      margin-top:0;
      color:#333;
      font-size:18px;
    }

    #calendar-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:12px
    }

    #calendar-header button{
      background:#8c75e6;
      color:#fff;
      border:0;
      width:36px;
      height:36px;
      border-radius:8px;
      cursor:pointer;
      font-weight:700;
      transition: background 0.2s ease;
    }

    #calendar-header button:hover{
      background:#7a63d3;
    }

    #month-year{
      margin:0;
      flex:1;
      text-align:center;
      color:#333;
    }

    #calendar-weekdays{
      display:grid;
      grid-template-columns:repeat(7,1fr);
      gap:6px;
      margin-bottom:8px;
      text-align:center;
    }

    #calendar-weekdays > div{
      font-weight:700;
      color:#8c75e6;
      font-size:12px;
    }

    #calendar-grid{
      display:grid;
      grid-template-columns:repeat(7,1fr);
      gap:6px;
      margin-bottom: 14px;
    }

    .calendar-legend{
      display:flex;
      flex-direction: column;
      gap:8px;
      font-size:13px;
    }

    .calendar-legend-item{
      display:flex;
      align-items:center;
      gap:6px;
    }

    .calendar-legend-dot{
      width:12px;
      height:12px;
      border-radius:50%;
    }

    .topbar-simple{
      position: fixed;
      top: 0; left: 0; right: 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 24px;
      background: #fff;
      box-shadow: 0 4px 10px rgba(0,0,0,0.08);
      z-index: 999;
    }

    .btn-back-menu{
      background: #fcbf24;
      border: 0;
      border-radius: 999px;
      padding: 8px 20px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .btn-back-menu:hover{
      transform: translateY(-1px);
      background: #f0a81f;
    }

    /* MODAL QR */
    #qr-modal.logout-modal{
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.45);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }

    #qr-modal .logout-box{
      max-width: 450px;
      width: 90%;
      background: #fff;
      border-radius: 16px;
      padding: 32px 28px;
      text-align: center;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    }

    #qr-image{
      max-width: 300px;
      max-height: 300px;
      width: 100%;
      height: auto;
      margin: 0 auto 12px auto;
      border-radius: 8px;
      display: block;
    }

    /* RESPONSIVE */
    @media (max-width: 900px){
      .mis-events-wrapper{
        grid-template-columns: 1fr;
        gap: 20px;
      }
      #calendar-section{
        position: static;
      }
    }

    .empty-message{
      text-align: center;
      padding: 40px 20px;
      color: #999;
      font-size: 16px;
    }
  </style>
</head>
<body class="menu-page">

  <!-- Barra superior -->
  <div class="topbar-simple">
    <div style="display:flex;align-items:center;gap:10px">
      <img src="{{ url_for('static', filename='img/logo.jpg') }}" class="logo-img" alt="logo" style="height:40px;width:auto">
      <strong>Quercus</strong>
    </div>
    <a href="{{ url_for('menu') }}" class="btn-back-menu">MEN√ö</a>
  </div>

  <div style="height:60px"></div>

  <main class="mis-events-wrapper">
    <!-- LADO IZQUIERDO: LISTADO DE EVENTOS -->
    <div>
      <h2 style="margin-top:0">Mis eventos registrados</h2>
      <div class="mis-events-list">
        {% if registros %}
          {% for reg in registros %}
            {% set ev = reg.event %}
            <div class="mis-event-card">
              <h3>{{ ev.title }}</h3>
              <p class="mis-event-fecha">
                üìÖ {{ ev.date }} ‚Äì {{ ev.location or 'Sin lugar' }}
              </p>
              <p>{{ ev.description or 'Sin descripci√≥n' }}</p>
              <p><strong>Estado:</strong> {{ reg.status or 'inscrito' }}</p>
              <div class="mis-event-actions">
                <button class="btn-ver-qr" type="button" onclick="openQRModal('{{ reg.registration_id }}', '{{ reg.qr_code }}')">
                  Ver QR
                </button>
                <button class="btn-cancelar-evento" type="button" onclick="cancelarEvento('{{ reg.registration_id }}', '{{ ev.event_id }}')">
                  Cancelar
                </button>
              </div>
            </div>
          {% endfor %}
        {% else %}
          <div class="empty-message">
            <p>No te has registrado a√∫n en ning√∫n evento.</p>
            <p style="font-size:14px">Visita la secci√≥n de <strong>Eventos</strong> para inscribirte.</p>
          </div>
        {% endif %}
      </div>
    </div>

    <!-- LADO DERECHO: CALENDARIO -->
    <div>
      <div id="calendar-section">
        <h3>Calendario de eventos</h3>
        <div id="calendar-header">
          <button id="prev-month" type="button">‚óÄ</button>
          <h4 id="month-year" style="margin:0;flex:1;text-align:center;color:#333">Enero 2025</h4>
          <button id="next-month" type="button">‚ñ∂</button>
        </div>
        <div id="calendar-weekdays">
          <div>Lun</div>
          <div>Mar</div>
          <div>Mi√©</div>
          <div>Jue</div>
          <div>Vie</div>
          <div style="color:#e74c3c">Sab</div>
          <div style="color:#e74c3c">Dom</div>
        </div>
        <div id="calendar-grid"></div>
        <div class="calendar-legend">
          <div class="calendar-legend-item">
            <div class="calendar-legend-dot" style="background:#8c75e6"></div>
            <span>Evento creado</span>
          </div>
          <div class="calendar-legend-item">
            <div class="calendar-legend-dot" style="background:#27ae60"></div>
            <span>Evento inscrito</span>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- Modal para mostrar el QR -->
  <div id="qr-modal" class="logout-modal" aria-hidden="true">
    <div class="logout-box">
      <img src="{{ url_for('static', filename='img/quercus.png') }}" alt="logo" class="modal-logo" style="max-width:180px;margin-bottom:10px;">
      <p style="margin-bottom:12px;font-weight:700;">C√≥digo QR de tu registro</p>
      <img id="qr-image" src="" alt="QR">
      <div class="modal-actions" style="margin-top:12px;">
        <button id="qr-close" class="btn-no">CERRAR</button>
      </div>
    </div>
  </div>

  <script>
    // Funci√≥n para abrir modal QR
    function openQRModal(registrationId, qrBase64) {
      const modal = document.getElementById('qr-modal');
      const qrImage = document.getElementById('qr-image');
      
      if (!modal || !qrImage) return;
      
      // Funci√≥n para cerrar modal
      function closeModal() {
        modal.style.display = 'none';
        modal.setAttribute('aria-hidden', 'true');
        qrImage.src = '';
      }
      
      // Mostrar modal
      modal.style.display = 'flex';
      modal.setAttribute('aria-hidden', 'false');
      
      // Establecer la imagen QR desde base64
      if (qrBase64 && qrBase64.trim()) {
        qrImage.src = 'data:image/png;base64,' + qrBase64;
      } else {
        console.error('No QR data available');
        alert('El c√≥digo QR no est√° disponible');
      }
      
      // Cerrar modal al hacer click en bot√≥n
      const closeBtn = document.getElementById('qr-close');
      if (closeBtn) {
        closeBtn.onclick = function(e) {
          e.stopPropagation();
          closeModal();
        };
      }
      
      // Cerrar modal al hacer click fuera (en el fondo)
      modal.onclick = function(e) {
        if (e.target === modal) {
          closeModal();
        }
      };
    }

    // Funci√≥n para cancelar evento
    async function cancelarEvento(registrationId, eventId) {
      const confirmed = confirm('¬øEst√°s seguro de que deseas cancelar tu registro en este evento?');
      if (!confirmed) return;

      try {
        const resp = await fetch(`/api/eventos/${eventId}/desregistrar`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }
        });
        
        if (resp.status === 401) {
          alert('Debes iniciar sesi√≥n.');
          window.location.href = '/login';
          return;
        }
        
        const data = await resp.json();
        if (resp.ok && data.ok) {
          // Recargar la p√°gina para reflejar los cambios
          location.reload();
        } else {
          alert(data.error || 'Error al cancelar el registro');
        }
      } catch (err) {
        console.error('Error:', err);
        alert('Error de conexi√≥n: ' + err.message);
      }
    }
  </script>

  <!-- Script del calendario -->
  <script>
    (function(){
      let currentDate = new Date();
      let eventosMap = {};

      const monthYearEl = document.getElementById('month-year');
      const calendarGridEl = document.getElementById('calendar-grid');
      const prevBtn = document.getElementById('prev-month');
      const nextBtn = document.getElementById('next-month');

      async function loadEvents(){
        try {
          const resp = await fetch('/api/user/events-calendar');
          if (!resp.ok) return;
          const data = await resp.json();
          eventosMap = {};

          if (data.creados) {
            data.creados.forEach(ev => {
              const fecha = ev.fecha;
              if (!eventosMap[fecha]) eventosMap[fecha] = { creados: [], inscritos: [] };
              eventosMap[fecha].creados.push(ev);
            });
          }

          if (data.inscritos) {
            data.inscritos.forEach(ev => {
              const fecha = ev.fecha;
              if (!eventosMap[fecha]) eventosMap[fecha] = { creados: [], inscritos: [] };
              eventosMap[fecha].inscritos.push(ev);
            });
          }

          renderCalendar();
        } catch (e) {
          console.warn('Error cargando eventos del calendario:', e);
        }
      }

      function renderCalendar(){
        if (!monthYearEl || !calendarGridEl) return;

        const year = currentDate.getFullYear();
        const month = currentDate.getMonth();
        const monthNames = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
        monthYearEl.textContent = monthNames[month] + ' ' + year;

        const firstDay = new Date(year, month, 1).getDay();
        const daysInMonth = new Date(year, month + 1, 0).getDate();
        const daysInPrevMonth = new Date(year, month, 0).getDate();

        calendarGridEl.innerHTML = '';

        for (let i = firstDay - 1; i >= 1; i--) {
          const dayEl = createDayCell(daysInPrevMonth - i + 1, true);
          calendarGridEl.appendChild(dayEl);
        }

        const today = new Date();
        for (let day = 1; day <= daysInMonth; day++) {
          const isToday = (year === today.getFullYear() && month === today.getMonth() && day === today.getDate());
          const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
          const dayEl = createDayCell(day, false, dateStr, isToday);
          calendarGridEl.appendChild(dayEl);
        }

        const totalCells = calendarGridEl.children.length;
        const remainingCells = 42 - totalCells;
        for (let day = 1; day <= remainingCells; day++) {
          const dayEl = createDayCell(day, true);
          calendarGridEl.appendChild(dayEl);
        }
      }

      function createDayCell(day, isOtherMonth, dateStr, isToday){
        const cell = document.createElement('div');
        cell.style.cssText = `
          background: ${isOtherMonth ? '#f0f0f0' : '#fff'};
          border-radius: 8px;
          padding: 8px 4px;
          min-height: 60px;
          border: 1px solid #e0e0e0;
          font-weight: ${isToday ? '800' : '600'};
          color: ${isOtherMonth ? '#aaa' : '#333'};
          display: flex;
          flex-direction: column;
          align-items: center;
          font-size: 12px;
          ${isToday ? 'background: #e3f2fd; border: 2px solid #8c75e6;' : ''}
        `;

        const numEl = document.createElement('div');
        numEl.textContent = day;
        numEl.style.fontWeight = '700';
        cell.appendChild(numEl);

        if (dateStr && eventosMap[dateStr]) {
          const eventos = eventosMap[dateStr];
          const dotsContainer = document.createElement('div');
          dotsContainer.style.cssText = 'display:flex;gap:2px;margin-top:3px';

          if (eventos.creados.length > 0) {
            const dot = document.createElement('div');
            dot.style.cssText = 'width:6px;height:6px;border-radius:50%;background:#8c75e6';
            dot.title = `${eventos.creados.length} creado(s)`;
            dotsContainer.appendChild(dot);
          }

          if (eventos.inscritos.length > 0) {
            const dot = document.createElement('div');
            dot.style.cssText = 'width:6px;height:6px;border-radius:50%;background:#27ae60';
            dot.title = `${eventos.inscritos.length} inscrito(s)`;
            dotsContainer.appendChild(dot);
          }

          if (dotsContainer.children.length > 0) {
            cell.appendChild(dotsContainer);
          }
        }

        return cell;
      }

      if (prevBtn) {
        prevBtn.addEventListener('click', function(){
          currentDate.setMonth(currentDate.getMonth() - 1);
          renderCalendar();
        });
      }

      if (nextBtn) {
        nextBtn.addEventListener('click', function(){
          currentDate.setMonth(currentDate.getMonth() + 1);
          renderCalendar();
        });
      }

      loadEvents();
    })();
  </script>

</body>
</html>
