<!doctype html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Eventos - Quercus</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
  <style>
    body.menu-page { text-align: center; }
    .events-container{max-width:1100px;margin:80px auto;padding:10px}
    .events-grid{display:flex;flex-direction:column;gap:18px;align-items:stretch}
    .events-grid-top, .events-grid-bottom{display:grid;gap:18px}
    .events-grid-top{grid-template-columns:repeat(4,1fr);}
    .events-grid-bottom{grid-template-columns:repeat(5,1fr);}
    .event-card{text-align:center;padding:8px;position:relative}
    .event-thumb{width:120px;height:120px;border-radius:22px;object-fit:cover;display:block;margin:0 auto 12px;box-shadow:0 8px 20px rgba(0,0,0,0.12);transition:transform .18s ease,box-shadow .18s ease;transform-origin:center}
    .event-card:hover .event-thumb{transform:scale(1.08);box-shadow:0 18px 40px rgba(0,0,0,0.18)}
    .event-label{font-weight:700;position:static;display:inline-block;margin-top:8px;background:transparent;color:#111;padding:6px 10px;border-radius:8px;z-index:2;white-space:nowrap}
    .event-header-icon{width:96px;height:auto;display:block;margin:0 auto 12px}
    .events-link-icon{width:150px;height:auto;margin-left:12px;vertical-align:middle;cursor:pointer;transition:transform .14s ease}
    .events-link-icon:hover{transform:scale(1.06)}
    .topbar-spacer{height:56px}
    .user-icon{ width:56px; height:auto; border-radius:8px; transition: transform .15s ease }
    .user-icon:hover{ transform: scale(1.08) }
    .profile-panel{position:fixed;top:56px;right:18px;z-index:10010;pointer-events:none}
    .profile-outer{background:#2f2f2f;border-radius:22px;padding:10px;box-shadow:0 14px 38px rgba(0,0,0,0.25);pointer-events:auto}
    .profile-inner{background:#fff;border-radius:14px;padding:12px 14px;width:220px;position:relative}
    .profile-close{position:absolute;right:8px;top:6px;border:0;background:#e74c3c;color:#fff;width:28px;height:28px;border-radius:6px;font-size:14px;cursor:pointer;display:inline-flex;align-items:center;justify-content:center}
    .profile-avatar-wrap{text-align:center;margin-top:6px}
    .profile-avatar-bottom{margin-top:10px}
    .profile-avatar{width:86px;height:86px;border-radius:50%;display:inline-block}
    .avatar-list{display:flex;gap:8px;justify-content:center;flex-wrap:wrap}
    .avatar-thumb{width:44px;height:44px;border-radius:8px;cursor:pointer;border:2px solid transparent;transition:transform .12s ease,border-color .12s ease}
    .avatar-thumb:hover{transform:translateY(-3px)}
    .avatar-thumb.selected{border-color:var(--primary, #8c75e6)}
    .profile-text{margin-top:10px;text-align:left}
    .profile-row{display:flex;flex-direction:column;align-items:center;margin-bottom:8px}
    .profile-row strong{font-size:12px;color:#333;margin-bottom:6px}
    .profile-row div{font-size:13px;color:#111}
    .editable{background:#f7f7f9;border-radius:8px;padding:6px 8px;min-width:140px;text-align:center}
    .profile-panel.hidden{opacity:0;transform:translateY(-6px) scale(.98);transition:all .14s ease}
    .profile-panel.open{opacity:1;transform:none}
    .logout-btn{background:#ff4757;color:#fff;border:0;padding:8px 14px;border-radius:10px;font-weight:700;cursor:pointer}
    .logout-btn:hover{background:#ff6b78}
    .logout-modal{position:fixed;left:0;top:0;width:100%;height:100%;display:flex;align-items:center;justify-content:center;z-index:11000;visibility:hidden;opacity:0;transition:opacity .12s ease}
    .logout-modal.visible{visibility:visible;opacity:1;background:rgba(0,0,0,0.45)}
    .logout-box{background:#fff;border-radius:14px;padding:18px 18px;max-width:360px;width:90%;text-align:center;box-shadow:0 20px 50px rgba(0,0,0,0.3)}
    .logout-box .modal-logo{width:64px;margin-bottom:10px}
    .logout-box p{font-weight:700;margin:6px 0 12px}
    .modal-actions{display:flex;gap:10px;justify-content:center}
    .btn-yes{background:#e74c3c;color:#fff;border:0;padding:8px 14px;border-radius:10px;cursor:pointer;font-weight:700;transition:background .12s ease, transform .12s ease}
    .btn-yes:hover{background:#ff6b6b;transform:translateY(-2px)}
    .btn-no{background:#f0f0f0;color:#333;border:0;padding:8px 14px;border-radius:10px;cursor:pointer;transition:background .12s ease, transform .12s ease}
    .btn-no:hover{background:#e6e6e6;transform:translateY(-2px)}
    .coming-modal{position:fixed;left:0;top:0;width:100%;height:100%;display:flex;align-items:center;justify-content:center;z-index:12000;visibility:hidden;opacity:0;transition:opacity .12s ease}
    .coming-modal.visible{visibility:visible;opacity:1;background:rgba(0,0,0,0.45)}
    .coming-box{background:#fff;border-radius:12px;padding:18px;max-width:520px;width:92%;text-align:center;box-shadow:0 30px 70px rgba(0,0,0,0.3)}
    .coming-box .coming-logo{width:76px;height:auto;display:block;margin:0 auto 10px}
    .coming-box p{margin:10px 0;font-weight:600;color:#222}
    .coming-ok{background:#8c75e6;color:#fff;border:0;padding:10px 16px;border-radius:10px;cursor:pointer;font-weight:700}
    .coming-ok:hover{transform:translateY(-2px)}
    .eventos-modal{position:fixed;left:0;top:0;width:100%;height:100%;display:flex;align-items:center;justify-content:center;z-index:13000;visibility:hidden;opacity:0;transition:opacity .12s ease;background:rgba(0,0,0,0.5)}
    .eventos-modal.visible{visibility:visible;opacity:1}
    .eventos-modal-content{background:#fff;border-radius:16px;padding:24px;max-width:700px;width:90%;max-height:80vh;overflow-y:auto;box-shadow:0 30px 70px rgba(0,0,0,0.3)}
    .eventos-modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px}
    .eventos-modal-header h2{margin:0;color:#222;font-size:24px}
    .eventos-modal-close{background:#e74c3c;color:#fff;border:0;width:32px;height:32px;border-radius:8px;cursor:pointer;font-size:18px;display:flex;align-items:center;justify-content:center}
    .eventos-modal-close:hover{background:#ff6b6b}
    .evento-item{background:#f9f9fb;border-left:4px solid #8c75e6;padding:16px;margin-bottom:16px;border-radius:8px;transition:transform .12s ease,box-shadow .12s ease}
    .evento-item:hover{transform:translateY(-2px);box-shadow:0 8px 20px rgba(0,0,0,0.1)}
    .evento-item h3{margin:0 0 8px 0;color:#333;font-size:18px;font-weight:700}
    .evento-item p{margin:6px 0;color:#666;font-size:14px}
    .evento-fecha{color:#8c75e6;font-weight:600}
    .evento-desc{color:#555;margin-top:10px}
    .evento-actions{display:flex;gap:10px;margin-top:12px}
    .btn-registrarse{background:#8c75e6;color:#fff;border:0;padding:8px 16px;border-radius:8px;cursor:pointer;font-weight:600;transition:all .12s ease;flex:1}
    .btn-registrarse:hover{background:#7860d4;transform:translateY(-2px)}
    .btn-registrarse.registered{background:#e74c3c;cursor:pointer}
    .btn-registrarse.registered:hover{background:#ff6b6b}
    @media (max-width:920px){ .events-grid-top{grid-template-columns:repeat(2,1fr);} .events-grid-bottom{grid-template-columns:repeat(2,1fr);} }
    @media (max-width:720px){ .event-thumb{width:100px;height:100px} .events-grid-top,.events-grid-bottom{grid-template-columns:1fr} }
    .btn-mis-eventos,.btn-menu-link{background:#8c75e6;color:#fff;padding:8px 16px;border-radius:999px;text-decoration:none;font-weight:700;font-size:14px;box-shadow:0 4px 10px rgba(0,0,0,0.18);display:inline-flex;align-items:center;justify-content:center;transition:all .12s ease;}
    .btn-mis-eventos:hover,.btn-menu-link:hover{transform:translateY(-2px);box-shadow:0 6px 14px rgba(0,0,0,0.22);}
  </style>
</head>
<body class="menu-page">
  <div class="topbar-register" style="justify-content:space-between;left:20px;right:20px;width:calc(100% - 40px);position:fixed;top:0;z-index:9998;padding:12px 24px;display:flex;align-items:center;">
    <div style="display:flex;align-items:center">
      <img src="{{ url_for('static', filename='img/logo.jpg') }}" class="logo-img" alt="logo">
      <a href="{{ url_for('menu') }}" title="Volver al men√∫">
        <img src="{{ url_for('static', filename='img/eventos/eventos.png') }}" alt="eventos" class="events-link-icon">
      </a>
      <a href="{{ url_for('mis_eventos') }}" class="btn-mis-eventos">Mis eventos</a>
    </div>
  </div>

  <div class="topbar-spacer"></div>

  <div id="coming-modal" class="coming-modal" aria-hidden="true">
    <div class="coming-box">
      <img src="{{ url_for('static', filename='img/logo.jpg') }}" alt="logo" class="coming-logo">
      <h3>Pr√≥ximamente</h3>
      <p id="coming-msg">Por el momento solo estamos en Bogot√°. Prontamente esperamos informar sobre tu sede. Dentro de poco uniremos m√°s a la comunidad UNAL. Disculpa las molestias.</p>
      <div style="margin-top:12px"><button id="coming-ok" class="coming-ok">Aceptar</button></div>
    </div>
  </div>

  <div id="eventos-modal" class="eventos-modal" aria-hidden="true">
    <div class="eventos-modal-content">
      <div class="eventos-modal-header">
        <h2>Eventos en Bogot√°</h2>
        <button id="eventos-modal-close" class="eventos-modal-close" aria-label="Cerrar">‚úï</button>
      </div>
      <div id="eventos-list-modal"></div>
    </div>
  </div>

  <main class="events-container">
    <img src="{{ url_for('static', filename='img/icono1.png') }}" alt="icono eventos" class="event-header-icon">
    <h2>EVENTOS</h2>

    <div style="background:#f9f9fb;border-radius:12px;padding:20px;margin-bottom:24px;box-shadow:0 6px 18px rgba(0,0,0,0.06)">
      <h3 style="margin-top:0;color:#333;font-size:16px">Buscar y filtrar eventos</h3>
      <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px">
        <div>
          <label style="display:block;font-weight:700;color:#333;font-size:12px;margin-bottom:6px">Nombre del evento</label>
          <input type="text" id="filter-nombre" placeholder="Buscar por nombre..." style="width:100%;padding:10px;border:1px solid #ddd;border-radius:8px;box-sizing:border-box">
        </div>
        <div>
          <label style="display:block;font-weight:700;color:#333;font-size:12px;margin-bottom:6px">Sede</label>
          <select id="filter-sede" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:8px;box-sizing:border-box">
            <option value="">Todas las sedes</option>
            <option value="Bogota">Bogota</option>
            <option value="Palmira">Palmira</option>
            <option value="Medellin">Medellin</option>
            <option value="Manizales">Manizales</option>
          </select>
        </div>
        <div>
          <label style="display:block;font-weight:700;color:#333;font-size:12px;margin-bottom:6px">Tipo de evento</label>
          <select id="filter-tipo" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:8px;box-sizing:border-box">
            <option value="">Todos los tipos</option>
            <option value="Charla">Charla</option>
            <option value="Conferencia">Conferencia</option>
            <option value="Taller">Taller</option>
            <option value="Seminario">Seminario</option>
            <option value="Mesa redonda">Mesa redonda</option>
          </select>
        </div>
        <div>
          <label style="display:block;font-weight:700;color:#333;font-size:12px;margin-bottom:6px">Fecha (desde)</label>
          <input type="date" id="filter-fecha" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:8px;box-sizing:border-box">
        </div>
      </div>
      <div style="margin-top:12px;display:flex;gap:8px">
        <button onclick="aplicarFiltros()" style="background:#8c75e6;color:#fff;border:0;padding:10px 20px;border-radius:8px;font-weight:700;cursor:pointer;transition:all 0.2s ease">üîç Filtrar</button>
        <button onclick="limpiarFiltros()" style="background:#f0f0f0;color:#333;border:0;padding:10px 20px;border-radius:8px;font-weight:700;cursor:pointer;transition:all 0.2s ease">Limpiar</button>
      </div>
    </div>

    <div id="eventos-filtrados" style="display:none;margin-bottom:24px">
      <h3 style="color:#333;margin-top:0">Resultados de la b√∫squeda</h3>
      <div id="eventos-list" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:16px"></div>
    </div>

    <div id="no-resultados" style="display:none;text-align:center;padding:40px;color:#999">
      <p>No se encontraron eventos que cumplan con los criterios de b√∫squeda.</p>
    </div>

    <h3 style="margin-top:32px;color:#333">Sedes UNAL</h3>
    <div class="events-grid">
      <div class="events-grid-top">
        <div class="event-card" id="bogota-card"><img src="{{ url_for('static', filename='img/eventos/bogota.png') }}" class="event-thumb"><div class="event-label">Bogot√°</div></div>
        <div class="event-card coming-soon" data-city="Medell√≠n"><img src="{{ url_for('static', filename='img/eventos/medellin.png') }}" class="event-thumb"><div class="event-label">Medell√≠n</div></div>
        <div class="event-card coming-soon" data-city="Palmira"><img src="{{ url_for('static', filename='img/eventos/palmira.png') }}" class="event-thumb"><div class="event-label">Palmira</div></div>
        <div class="event-card coming-soon" data-city="Manizales"><img src="{{ url_for('static', filename='img/eventos/manizales.png') }}" class="event-thumb"><div class="event-label">Manizales</div></div>
      </div>
    </div>
  </main>

  <script>
    // Coming soon handler
    (function(){
      const coming = document.querySelectorAll('.coming-soon');
      const modal = document.getElementById('coming-modal');
      const ok = document.getElementById('coming-ok');
      const msg = document.getElementById('coming-msg');
      function show(city){
        const place = city || 'tu sede';
        msg.textContent = 'Por el momento solo estamos en Bogot√°; pronto esperamos informar sobre ' + place + '. Dentro de poco ampliaremos la comunidad UNAL. Disculpa las molestias.';
        modal.classList.add('visible'); modal.setAttribute('aria-hidden','false');
      }
      function hide(){ modal.classList.remove('visible'); modal.setAttribute('aria-hidden','true'); }
      coming.forEach(c => c.addEventListener('click', function(e){ e.stopPropagation(); const city = this.dataset && this.dataset.city ? this.dataset.city : ''; show(city); }));
      ok && ok.addEventListener('click', function(){ hide(); });
      modal && modal.addEventListener('click', function(ev){ if(ev.target === modal) hide(); });
    })();

    // Bogot√° card and modal
    (function(){
      const bogotaCard = document.getElementById('bogota-card');
      const eventosModal = document.getElementById('eventos-modal');
      const eventosListModal = document.getElementById('eventos-list-modal');
      const closeBtn = document.getElementById('eventos-modal-close');

      function mostrarModal(eventos) {
        eventosListModal.innerHTML = '';
        eventos.forEach(ev => {
          const registrado = !!ev.registrado;
          const estado = registrado ? 'registrado' : 'no_registrado';
          const html = `
            <div class="evento-item">
              <h3>${ev.titulo}</h3>
              <p class="evento-fecha">üìÖ ${ev.fecha || 'Sin fecha'}</p>
              <p class="evento-desc">${ev.descripcion || 'Sin descripci√≥n'}</p>
              <div class="evento-actions">
                <button class="btn-registrarse ${registrado ? 'registered' : ''}" data-evento-id="${ev.id}" data-estado="${estado}">
                  ${registrado ? '‚úì Registrado (Cancelar)' : 'Registrarse'}
                </button>
              </div>
            </div>
          `;
          eventosListModal.insertAdjacentHTML('beforeend', html);
        });

        document.querySelectorAll('.btn-registrarse').forEach(btn => {
          btn.addEventListener('click', async function(e){
            e.stopPropagation();
            const boton = this;
            const eventoId = boton.dataset.eventoId;
            let estado = boton.dataset.estado || 'no_registrado';

            if (estado === 'no_registrado') {
              try {
                const resp = await fetch(`/api/eventos/${eventoId}/registrar`, {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' }
                });
                const data = await resp.json();

                if (resp.status === 401) {
                  alert('Debes iniciar sesi√≥n para registrarte en un evento.');
                  window.location.href = '/login';
                  return;
                }

                if (!resp.ok || !data.ok) {
                  alert(data.error || 'Error al registrarse en el evento.');
                  return;
                }

                boton.dataset.estado = 'registrado';
                boton.classList.add('registered');
                boton.textContent = '‚úì Registrado (Cancelar)';
                console.log('Registrado en evento:', eventoId);

              } catch (err) {
                console.error('Error al registrarse en el evento:', err);
                alert('Error de conexi√≥n al registrarse en el evento.');
              }
            } else {
              const seguro = confirm('¬øQuieres cancelar tu registro en este evento?');
              if (!seguro) return;

              try {
                const resp = await fetch(`/api/eventos/${eventoId}/desregistrar`, {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' }
                });
                const data = await resp.json();

                if (resp.status === 401) {
                  alert('Debes iniciar sesi√≥n.');
                  window.location.href = '/login';
                  return;
                }

                if (!resp.ok || !data.ok) {
                  alert(data.error || 'Error al cancelar el registro.');
                  return;
                }

                boton.dataset.estado = 'no_registrado';
                boton.classList.remove('registered');
                boton.textContent = 'Registrarse';
                console.log('Desregistrado de evento:', eventoId);

              } catch (err) {
                console.error('Error al desregistrarse del evento:', err);
                alert('Error de conexi√≥n al cancelar el registro.');
              }
            }
          });
        });

        eventosModal.classList.add('visible');
        eventosModal.setAttribute('aria-hidden', 'false');
      }

      bogotaCard && bogotaCard.addEventListener('click', async function(e){
        e.stopPropagation();
        try {
          const response = await fetch('/api/eventos');
          const eventos = await response.json();

          console.log('Eventos recibidos:', eventos);

          if (!eventos || eventos.length === 0) {
            alert('No hay eventos disponibles en Bogot√° por el momento.');
            return;
          }

          mostrarModal(eventos);
        } catch (err) {
          console.error('Error cargando eventos:', err);
          alert('Error al cargar los eventos.');
        }
      });

      closeBtn && closeBtn.addEventListener('click', function(e){
        e.stopPropagation();
        eventosModal.classList.remove('visible');
        eventosModal.setAttribute('aria-hidden', 'true');
      });

      eventosModal && eventosModal.addEventListener('click', function(ev){
        if (ev.target === eventosModal) {
          eventosModal.classList.remove('visible');
          eventosModal.setAttribute('aria-hidden', 'true');
        }
      });
    })();
  </script>

  <!-- GLOBAL FILTER FUNCTIONS -->
  <script>
    window.aplicarFiltros = async function(){
      const nombre = document.getElementById('filter-nombre').value.toLowerCase();
      const sede = document.getElementById('filter-sede').value;
      const tipo = document.getElementById('filter-tipo').value;
      const fecha = document.getElementById('filter-fecha').value;

      try {
        const resp = await fetch('/api/eventos');
        if (!resp.ok) throw new Error('Error en /api/eventos');
        const eventos = await resp.json();

        console.log('Eventos obtenidos:', eventos.length);

        let filtrados = eventos;

        if (nombre) {
          filtrados = filtrados.filter(e => (e.titulo || '').toLowerCase().includes(nombre));
        }

        if (sede) {
          filtrados = filtrados.filter(e => (e.lugar || '').includes(sede));
        }

        if (tipo) {
          filtrados = filtrados.filter(e => (e.categoria || '').includes(tipo));
        }

        if (fecha) {
          filtrados = filtrados.filter(e => (e.fecha || '') >= fecha);
        }

        console.log('Eventos filtrados:', filtrados.length);
        mostrarEventosFiltrados(filtrados);
      } catch (err) {
        console.error('Error filtrando eventos:', err);
      }
    };

    window.limpiarFiltros = function(){
      document.getElementById('filter-nombre').value = '';
      document.getElementById('filter-sede').value = '';
      document.getElementById('filter-tipo').value = '';
      document.getElementById('filter-fecha').value = '';

      document.getElementById('eventos-filtrados').style.display = 'none';
      document.getElementById('no-resultados').style.display = 'none';
    };

    function mostrarEventosFiltrados(eventos){
      const contenedor = document.getElementById('eventos-list');
      const filtradosDiv = document.getElementById('eventos-filtrados');
      const noResultadosDiv = document.getElementById('no-resultados');

      if (!eventos || eventos.length === 0) {
        filtradosDiv.style.display = 'none';
        noResultadosDiv.style.display = 'block';
        return;
      }

      contenedor.innerHTML = eventos.map(ev => `
        <div style="background:#f9f9fb;border-radius:12px;padding:16px;box-shadow:0 6px 18px rgba(0,0,0,0.06);transition:all 0.2s ease">
          <h4 style="margin:0 0 8px 0;color:#333;font-size:16px">${ev.titulo || 'Sin nombre'}</h4>
          <p style="margin:4px 0;color:#666;font-size:14px">üìÖ ${ev.fecha || 'Sin fecha'}</p>
          <p style="margin:4px 0;color:#666;font-size:14px">üìç ${ev.lugar || 'Sin ubicaci√≥n'}</p>
          <p style="margin:4px 0;color:#666;font-size:13px">${ev.descripcion || 'Sin descripci√≥n'}</p>
          <p style="margin:8px 0 0 0;color:#8c75e6;font-weight:700;font-size:13px">${ev.categoria || 'Sin categor√≠a'}</p>
          <button onclick="registrarEnEvento(${ev.id})" style="margin-top:8px;background:#8c75e6;color:#fff;border:0;padding:8px 12px;border-radius:8px;font-weight:700;cursor:pointer;font-size:12px">Registrarse</button>
        </div>
      `).join('');

      filtradosDiv.style.display = 'block';
      noResultadosDiv.style.display = 'none';
    }

    window.registrarEnEvento = async function(eventoId){
      try {
        const resp = await fetch(`/api/eventos/${eventoId}/registrar`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }
        });
        const data = await resp.json();

        if (resp.status === 401) {
          alert('Debes iniciar sesi√≥n.');
          window.location.href = '/login';
          return;
        }

        if (!resp.ok) {
          alert(data.error || 'Error al registrarse en el evento.');
          return;
        }

        alert('¬°Registrado correctamente en el evento!');
        limpiarFiltros();
      } catch (err) {
        console.error('Error al registrarse:', err);
        alert('Error de conexi√≥n');
      }
    };

    // Load events on page load
    window.addEventListener('DOMContentLoaded', function() {
      aplicarFiltros();
    });
  </script>
</body>
</html>
